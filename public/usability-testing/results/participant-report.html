<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pastree - Individual Participant Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #2c3e50;
        }
        
        .report-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .participant-id {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .upload-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .upload-btn:hover {
            background: #764ba2;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .profile-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .profile-label {
            font-size: 0.85em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .profile-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .score-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .score-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .score-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .task-journey {
            margin-top: 30px;
        }
        
        .task-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .task-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .task-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-failure {
            background: #f8d7da;
            color: #721c24;
        }
        
        .task-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .feedback-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #2ecc71;
        }
        
        .feedback-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .quote-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .quote-text {
            font-style: italic;
            color: #2c3e50;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .comparison-note {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.95em;
            color: #856404;
        }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .export-btn {
            background: #2ecc71;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .export-btn:hover {
            background: #27ae60;
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #95a5a6;
        }
        
        .no-data-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
        
        .rating-stars {
            display: inline-block;
            margin-left: 10px;
        }
        
        .star {
            color: #f39c12;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="report-container">
        
        <div class="header">
            <h1>Individual Participant Report</h1>
            <div class="participant-id" id="participantIdDisplay">--</div>
        </div>
        
        <div class="upload-section" id="uploadSection">
            <h3>üìÅ Load Participant Data</h3>
            <p>Upload the participant's JSON files (pre-test, post-task, and post-test)</p>
            <input type="file" id="fileUpload" accept=".json" multiple style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileUpload').click()">
                Choose Files
            </button>
        </div>
        
        <div id="reportContent" style="display: none;">
            
            <!-- Overview Scores -->
            <div class="score-cards">
                <div class="score-card">
                    <div class="score-label">SUS Score</div>
                    <div class="score-value" id="susScore">--</div>
                    <div class="score-subtitle" id="susGrade">--</div>
                </div>
                
                <div class="score-card">
                    <div class="score-label">NPS Score</div>
                    <div class="score-value" id="npsScore">--</div>
                    <div class="score-subtitle" id="npsCategory">--</div>
                </div>
                
                <div class="score-card">
                    <div class="score-label">Tasks Completed</div>
                    <div class="score-value" id="tasksCompleted">--</div>
                    <div class="score-subtitle">out of 6 tasks</div>
                </div>
            </div>
            
            <!-- Participant Profile -->
            <div class="section">
                <h2 class="section-title">üë§ Participant Profile</h2>
                <div class="profile-grid" id="profileGrid">
                    <!-- Dynamic profile data -->
                </div>
            </div>
            
            <!-- Task Performance -->
            <div class="section">
                <h2 class="section-title">üìã Task-by-Task Journey</h2>
                <div class="chart-container">
                    <canvas id="taskPerformanceChart"></canvas>
                </div>
                <div id="taskJourney" class="task-journey">
                    <!-- Dynamic task items -->
                </div>
            </div>
            
            <!-- SUS Breakdown -->
            <div class="section">
                <h2 class="section-title">üìä System Usability Scale Breakdown</h2>
                <div class="chart-container">
                    <canvas id="susBreakdownChart"></canvas>
                </div>
                <div class="comparison-note" id="susComparison">
                    <!-- Comparison to average -->
                </div>
            </div>
            
            <!-- Feature Preferences -->
            <div class="section">
                <h2 class="section-title">üéØ Feature Assessment</h2>
                <div id="featureAssessment">
                    <!-- Dynamic content -->
                </div>
            </div>
            
            <!-- Qualitative Feedback -->
            <div class="section">
                <h2 class="section-title">üí¨ Participant Feedback</h2>
                <div id="feedbackSection">
                    <!-- Dynamic feedback -->
                </div>
            </div>
            
            <!-- Export -->
            <div class="section export-section">
                <h2 class="section-title">üì• Export Report</h2>
                <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
                <button class="export-btn" onclick="exportJSON()">üíæ Export JSON</button>
            </div>
            
        </div>
        
        <div id="noData" class="section no-data">
            <div class="no-data-icon">üìÇ</div>
            <h2>No Data Loaded</h2>
            <p>Please upload participant JSON files to view the report</p>
        </div>
        
    </div>
    
    <!-- Session Manager -->
    <script src="../session-manager.js?v=2.0"></script>
    
    <script>
        // Version 2.9 - Fixed task completion logic consistency between highlight card and task list
        console.log('üöÄ Participant Report Script v2.9 loaded');
        
        let participantData = {
            pretest: null,
            posttask: null,
            posttest: null
        };
        
        let participantId = '';
        let currentSessionId = null;
        
        // Auto-load data from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Participant Report loading...');
            
            // Check for session ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            if (sessionId) {
                // Load specific session data
                loadSessionData(sessionId);
            } else {
                // Load all sessions and show participant selector
                loadAllSessions();
            }
        });
        
        // Load specific session data
        function loadSessionData(sessionId) {
            const session = sessionManager.getSession(sessionId);
            if (session) {
                console.log('üìä Loading session data:', sessionId);
                currentSessionId = sessionId;
                
                // Convert session data to report format
                participantData.pretest = session.data.pretest;
                participantData.posttask = session.data.posttask;
                participantData.posttest = session.data.posttest;
                participantId = session.participantId;
                
                processReport();
            } else {
                console.log('‚ùå Session not found:', sessionId);
                loadAllSessions();
            }
        }
        
        // Load all sessions and show participant selector
        function loadAllSessions() {
            const sessions = sessionManager.getAllSessions();
            console.log('üìä Loading all sessions:', sessions.length);
            
            if (sessions.length === 0) {
                console.log('üì≠ No sessions found');
                return;
            }
            
            // Show participant selector
            showParticipantSelector(sessions);
        }
        
        // Show participant selector
        function showParticipantSelector(sessions) {
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.innerHTML = `
                <h3>üë• Select Participant</h3>
                <p>Choose a participant to view their individual report</p>
                <select id="participantSelector" style="padding: 10px; margin: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 1em;">
                    <option value="">Select a participant...</option>
                </select>
                <br>
                <button id="viewReportBtn" class="upload-btn" style="display: none;">View Report</button>
                <button id="viewDashboardBtn" class="upload-btn" style="background: #2ecc71; margin-left: 10px;">View Dashboard</button>
            `;
            
            const selector = document.getElementById('participantSelector');
            const viewBtn = document.getElementById('viewReportBtn');
            const dashboardBtn = document.getElementById('viewDashboardBtn');
            
            // Populate selector
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.sessionId;
                option.textContent = `${session.participantId} (${sessionManager.getTimeRemaining(session)} remaining)`;
                selector.appendChild(option);
            });
            
            // Handle selection
            selector.addEventListener('change', function() {
                if (this.value) {
                    viewBtn.style.display = 'inline-block';
                    viewBtn.textContent = `View ${sessions.find(s => s.sessionId === this.value).participantId} Report`;
                } else {
                    viewBtn.style.display = 'none';
                }
            });
            
            // Handle view report
            viewBtn.addEventListener('click', function() {
                const selectedSessionId = selector.value;
                if (selectedSessionId) {
                    loadSessionData(selectedSessionId);
                }
            });
            
            // Handle view dashboard
            dashboardBtn.addEventListener('click', function() {
                window.open('../dashboard.html', '_blank');
            });
        }
        let charts = {};
        
        const taskDescriptions = {
            1: "Install Pastree and capture first clipboard item",
            2: "Find and paste a previously copied item",
            3: "Create a custom list and add items",
            4: "Mark items as favorites",
            5: "Use search to find a specific item",
            6: "Configure settings and keyboard shortcuts"
        };
        
        // Check if Chart.js is loaded
        function checkChartJS() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded! Check internet connection.');
                alert('Error: Chart.js library failed to load. Please check your internet connection and refresh the page.');
                return false;
            }
            console.log('Chart.js loaded successfully:', Chart.version);
            return true;
        }
        
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        console.log('üìÅ Processing file:', file.name);
                        const data = JSON.parse(event.target.result);
                        console.log('üìÑ Parsed JSON successfully:', data);
                        categorizeData(data);
                    } catch (error) {
                        console.error('‚ùå Error parsing file:', file.name, error);
                        alert('Error parsing ' + file.name + ': ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            setTimeout(() => {
                if (hasData()) {
                    if (checkChartJS()) {
                        processReport();
                    }
                }
            }, 500);
        });
        
        function categorizeData(data) {
            console.log('=== CATEGORIZING DATA ===');
            console.log('File data:', data);
            console.log('Has responses?', !!data.responses);
            console.log('Response keys:', data.responses ? Object.keys(data.responses) : 'No responses');
            
            // Clean NaN values from responses
            if (data.responses) {
                for (let key in data.responses) {
                    if (data.responses[key] === 'NaN' || data.responses[key] === NaN || 
                        (typeof data.responses[key] === 'string' && data.responses[key].toLowerCase() === 'nan')) {
                        console.log('üßπ Cleaning NaN value for field:', key);
                        data.responses[key] = null; // or '' for empty string
                    }
                }
            }
            
            // Set participant ID from first file
            if (!participantId) {
                participantId = data.participantId;
            }
            
            // Check for SUS questions (post-test)
            if (data.responses && data.responses.sus1) {
                console.log('‚úÖ Categorized as POST-TEST SUS (found sus1)');
                if (!participantData.posttest) {
                    participantData.posttest = { responses: {} };
                }
                // Merge SUS responses
                Object.assign(participantData.posttest.responses, data.responses);
                participantData.posttest.participantId = data.participantId;
            } 
            // Check for NPS questions (post-test)
            else if (data.responses && data.responses.nps) {
                console.log('‚úÖ Categorized as POST-TEST NPS (found nps)');
                if (!participantData.posttest) {
                    participantData.posttest = { responses: {} };
                }
                // Merge NPS responses
                Object.assign(participantData.posttest.responses, data.responses);
                participantData.posttest.participantId = data.participantId;
            }
            // Check for feedback questions (post-test)
            else if (data.responses && (data.responses['liked-most'] || data.responses['improvements'] || data.responses['additional-feedback'])) {
                console.log('‚úÖ Categorized as POST-TEST FEEDBACK (found feedback fields)');
                if (!participantData.posttest) {
                    participantData.posttest = { responses: {} };
                }
                // Merge feedback responses
                Object.assign(participantData.posttest.responses, data.responses);
                participantData.posttest.participantId = data.participantId;
            }
            // Check for task questions (post-task) - look for any task-related fields
            else if (data.responses && (data.responses.task1Ease || data.responses['task1-ease'] || data.responses.task1ease || 
                     data.responses.task2Ease || data.responses['task2-ease'] || 
                     data.responses.task3Ease || data.responses['task3-ease'] || 
                     data.responses.task4Ease || data.responses['task4-ease'] || 
                     data.responses.task5Ease || data.responses['task5-ease'] || 
                     data.responses.task6Ease || data.responses['task6-ease'])) {
                console.log('‚úÖ Categorized as POST-TASK (found task ease fields)');
                // Normalize field names to camelCase for consistency
                if (data.responses['task1-ease'] || data.responses['task2-ease'] || data.responses['task3-ease'] || 
                    data.responses['task4-ease'] || data.responses['task5-ease'] || data.responses['task6-ease']) {
                    const normalized = {};
                    for (let key in data.responses) {
                        // Convert task1-ease to task1Ease, etc.
                        const newKey = key.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                        normalized[newKey] = data.responses[key];
                    }
                    data.responses = normalized;
                    console.log('üîÑ Normalized field names:', Object.keys(normalized));
                }
                if (!participantData.posttask) {
                    participantData.posttask = { responses: {} };
                }
                // Merge task responses
                Object.assign(participantData.posttask.responses, data.responses);
                participantData.posttask.participantId = data.participantId;
            } 
            // Check for pre-test questions (demographics)
            else if (data.responses && data.responses.age) {
                console.log('‚úÖ Categorized as PRE-TEST (found age)');
                participantData.pretest = data;
            } 
            // Check for pre-test by filename pattern as fallback
            else if (data.participantId && (data.participantId.startsWith('P') || data.participantId.match(/^\d+$/))) {
                console.log('‚úÖ Categorized as PRE-TEST (by participant ID pattern)');
                participantData.pretest = data;
            } else {
                console.log('‚ùå UNKNOWN DATA TYPE - Could not categorize');
                console.log('Available response fields:', data.responses ? Object.keys(data.responses) : 'No responses object');
            }
            
            console.log('Categorized file:', data.participantId, '- Type:', 
                participantData.posttest && participantData.posttest.responses === data.responses ? 'Post-Test' : 
                participantData.posttask && participantData.posttask.responses === data.responses ? 'Post-Task' : 
                participantData.pretest === data ? 'Pre-Test' : 'Unknown');
        }
        
        function hasData() {
            return participantData.pretest || participantData.posttask || participantData.posttest;
        }
        
        // Utility function to safely parse numeric values and handle NaN
        function safeParseNumber(value) {
            if (value === null || value === undefined || value === '' || value === 'NaN') {
                return null;
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? null : parsed;
        }
        
        // Utility function to get numeric value from responses with fallback
        function getNumericValue(responses, fieldName, fallback = null) {
            const value = responses[fieldName];
            const parsed = safeParseNumber(value);
            return parsed !== null ? parsed : fallback;
        }
        
        // Calculate SUS score from individual responses
        function calculateSUSScore(responses) {
            const susQuestions = ['sus1', 'sus2', 'sus3', 'sus4', 'sus5', 'sus6', 'sus7', 'sus8', 'sus9', 'sus10'];
            let totalScore = 0;
            let validResponses = 0;
            
            susQuestions.forEach((question, index) => {
                const value = getNumericValue(responses, question);
                if (value !== null && value >= 1 && value <= 5) {
                    // SUS scoring: odd questions (1,3,5,7,9) are positive, even questions (2,4,6,8,10) are negative
                    if ((index + 1) % 2 === 1) {
                        // Odd questions: score = value - 1
                        totalScore += (value - 1);
                    } else {
                        // Even questions: score = 5 - value
                        totalScore += (5 - value);
                    }
                    validResponses++;
                }
            });
            
            if (validResponses === 0) return null;
            
            // SUS score = (sum of scores) * 2.5
            return (totalScore * 2.5);
        }
        
        function processReport() {
            document.getElementById('reportContent').style.display = 'block';
            document.getElementById('noData').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            
            // Merge all post-test responses into a single object for compatibility
            if (participantData.posttest) {
                const allPostTestResponses = {};
                if (participantData.posttest.sus && participantData.posttest.sus.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.sus.responses);
                }
                if (participantData.posttest.nps && participantData.posttest.nps.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.nps.responses);
                }
                if (participantData.posttest.feedback && participantData.posttest.feedback.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.feedback.responses);
                }
                
                // Create a responses object for compatibility
                participantData.posttest.responses = allPostTestResponses;
                
                // Calculate SUS score if we have SUS responses
                if (allPostTestResponses.sus1) {
                    participantData.posttest.susScore = calculateSUSScore(allPostTestResponses);
                    console.log(`üìä Calculated SUS score for ${participantId}: ${participantData.posttest.susScore}`);
                }
            }
            
            // Merge all post-task responses into a single object for compatibility
            if (participantData.posttask && Array.isArray(participantData.posttask)) {
                const allPostTaskResponses = {};
                participantData.posttask.forEach((taskData, index) => {
                    if (taskData && taskData.responses) {
                        console.log(`üìä Task ${index + 1} (${taskData.task}):`, taskData.responses);
                        console.log(`üìä Task ${index + 1} success field:`, taskData.responses[`${taskData.task}-success`]);
                        Object.assign(allPostTaskResponses, taskData.responses);
                    }
                });
                
                // Create a responses object for compatibility
                participantData.posttask.responses = allPostTaskResponses;
                console.log(`üìä Merged ${participantData.posttask.length} task responses for ${participantId}`);
                console.log(`üìä All task response fields:`, Object.keys(allPostTaskResponses));
                
                // Debug: Check what success fields we actually have
                const successFields = Object.keys(allPostTaskResponses).filter(key => key.includes('success'));
                console.log(`üìä Success fields found:`, successFields);
                successFields.forEach(field => {
                    console.log(`üìä ${field}: ${allPostTaskResponses[field]}`);
                });
                
                // Debug: Check each individual task submission
                console.log(`üìä Individual task submissions analysis:`);
                participantData.posttask.forEach((taskData, index) => {
                    console.log(`üìä Task ${index + 1} (${taskData.task}):`);
                    console.log(`  - Success field: ${taskData.task}-success = ${taskData.responses[`${taskData.task}-success`]}`);
                    console.log(`  - All response keys:`, Object.keys(taskData.responses));
                });
            }
            
            document.getElementById('participantIdDisplay').textContent = participantId || 'Unknown';
            
            // Log what data we have
            console.log('=== Data Status ===');
            console.log('Pre-test data:', participantData.pretest ? '‚úÖ Loaded' : '‚ùå Missing');
            console.log('Post-task data:', participantData.posttask ? '‚úÖ Loaded' : '‚ùå Missing');
            console.log('Post-test data:', participantData.posttest ? '‚úÖ Loaded' : '‚ùå Missing');
            console.log('Participant ID:', participantId);
            
            if (participantData.pretest) {
                console.log('Pre-test fields:', Object.keys(participantData.pretest.responses || {}));
            }
            if (participantData.posttest) {
                console.log('Post-test structure:', participantData.posttest);
                console.log('SUS data:', participantData.posttest.sus);
                console.log('NPS data:', participantData.posttest.nps);
                console.log('Feedback data:', participantData.posttest.feedback);
                
                // Merge all post-test responses into a single object for compatibility
                const allPostTestResponses = {};
                if (participantData.posttest.sus && participantData.posttest.sus.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.sus.responses);
                }
                if (participantData.posttest.nps && participantData.posttest.nps.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.nps.responses);
                }
                if (participantData.posttest.feedback && participantData.posttest.feedback.responses) {
                    Object.assign(allPostTestResponses, participantData.posttest.feedback.responses);
                }
                
                console.log('Merged post-test responses:', allPostTestResponses);
                console.log('NPS value:', allPostTestResponses.nps);
                console.log('Satisfaction value:', allPostTestResponses.satisfaction);
                console.log('Continue-use value:', allPostTestResponses['continue-use']);
                console.log('Most-valuable value:', allPostTestResponses['most-valuable']);
            }
            
            // Show warning if missing data
            const missingData = [];
            if (!participantData.pretest) missingData.push('Pre-Test Questionnaire');
            if (!participantData.posttask) missingData.push('Post-Task Questions');
            if (!participantData.posttest) missingData.push('Post-Test Questionnaire');
            
            if (missingData.length > 0) {
                const warning = document.createElement('div');
                warning.style.cssText = 'background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;';
                warning.innerHTML = `
                    <strong>‚ö†Ô∏è Missing Data:</strong> The following files are missing:<br>
                    ${missingData.map(d => `‚Ä¢ ${d}`).join('<br>')}
                    <br><br>
                    <small>Some sections may be incomplete. Please upload all 3 JSON files for a complete report.</small>
                `;
                document.getElementById('reportContent').insertBefore(warning, document.getElementById('reportContent').firstChild);
            }
            
            buildOverviewScores();
            buildProfile();
            buildTaskJourney();
            buildSUSBreakdown();
            buildFeatureAssessment();
            buildFeedback();
        }
        
        function buildOverviewScores() {
            if (participantData.posttest) {
                const susScore = participantData.posttest.susScore;
                if (susScore !== null && susScore !== undefined) {
                    document.getElementById('susScore').textContent = susScore.toFixed(1);
                    document.getElementById('susGrade').textContent = getSUSGrade(susScore);
                } else {
                    document.getElementById('susScore').textContent = 'N/A';
                    document.getElementById('susGrade').textContent = 'No Data';
                }
                
                const npsScore = getNumericValue(participantData.posttest.responses, 'nps');
                if (npsScore !== null) {
                    document.getElementById('npsScore').textContent = npsScore;
                    document.getElementById('npsCategory').textContent = getNPSCategory(npsScore);
                } else {
                    document.getElementById('npsScore').textContent = 'N/A';
                    document.getElementById('npsCategory').textContent = 'No Data';
                }
            }
            
            if (participantData.posttask && Array.isArray(participantData.posttask)) {
                let completed = 0;
                console.log('üîç Checking task completion from actual task data...');
                
                // Count based on actual task submissions
                participantData.posttask.forEach((taskData, index) => {
                    if (taskData && taskData.responses) {
                        const taskName = taskData.task;
                        const successField = `${taskName}-success`;
                        const successValue = taskData.responses[successField];
                        
                        console.log(`üîç ${taskName}: ${successField} = ${successValue}`);
                        
                        // Count as completed if: yes, partial, or any non-empty value (indicating attempt)
                        if (successValue === 'yes' || successValue === 'Yes' || successValue === 'partial' || 
                            successValue === 'Partial' || (successValue && successValue !== 'no' && successValue !== 'No')) {
                            completed++;
                            console.log(`‚úÖ ${taskName} counted as completed (value: ${successValue})`);
                        } else {
                            console.log(`‚ùå ${taskName} not completed (value: ${successValue})`);
                        }
                    }
                });
                
                console.log(`üìä Total tasks completed: ${completed}/${participantData.posttask.length}`);
                console.log(`üìä Expected 6 tasks, but found ${participantData.posttask.length} task submissions`);
                
                // Show just the completed count (no fraction)
                document.getElementById('tasksCompleted').textContent = completed;
            } else {
                console.log('‚ùå No post-task data available for completion counting');
                document.getElementById('tasksCompleted').textContent = 'N/A';
            }
        }
        
        function buildProfile() {
            const grid = document.getElementById('profileGrid');
            grid.innerHTML = '';
            
            if (!participantData.pretest) {
                grid.innerHTML = '<p style="color: #e74c3c; padding: 20px; text-align: center;">‚ùå Pre-test data not loaded. Please upload the pre-test questionnaire JSON file.</p>';
                return;
            }
            
            const profile = participantData.pretest.responses;
            
            const fields = [
                { label: 'Age', value: profile.age },
                { label: 'Gender', value: profile.gender },
                { label: 'Occupation', value: profile.occupation },
                { label: 'Education', value: profile.education },
                { label: 'Tech Proficiency', value: profile['techProficiency'] || profile['tech-proficiency'] },
                { label: 'Primary Browser', value: profile['primary-browser'] },
                { label: 'Browser Extensions', value: profile['browser-extensions'] },
                { label: 'Copy/Paste Frequency', value: profile['copy-paste-frequency'] }
            ];
            
            fields.forEach(field => {
                if (field.value) {
                    const item = document.createElement('div');
                    item.className = 'profile-item';
                    item.innerHTML = `
                        <div class="profile-label">${field.label}</div>
                        <div class="profile-value">${field.value}</div>
                    `;
                    grid.appendChild(item);
                }
            });
        }
        
        function buildTaskJourney() {
            const journey = document.getElementById('taskJourney');
            journey.innerHTML = '';
            
            if (!participantData.posttask) {
                journey.innerHTML = '<p style="color: #e74c3c; padding: 20px; text-align: center;">‚ùå Post-task data not loaded. Please upload the post-task questions JSON file.</p>';
                return;
            }
            
            const easeData = [];
            
            for (let i = 1; i <= 6; i++) {
                const responses = participantData.posttask.responses;
                // Handle both camelCase and hyphenated formats
                const ease = parseInt(responses[`task${i}Ease`] || responses[`task${i}-ease`] || 0);
                const successValue = responses[`task${i}Success`] || responses[`task${i}-success`];
                const success = successValue === 'yes' || successValue === 'Yes' || successValue === 'partial' || 
                               successValue === 'Partial' || (successValue && successValue !== 'no' && successValue !== 'No');
                const time = responses[`task${i}Time`] || responses[`task${i}-time`] || responses[`task${i}time`] || 'Not recorded';
                const difficulties = responses[`task${i}Difficulties`] || responses[`task${i}-difficulties`] || 'None reported';
                const feedback = responses[`task${i}Feedback`] || responses[`task${i}-feedback`] || 'No additional feedback';
                
                easeData.push(ease);
                
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">Task ${i}: ${taskDescriptions[i]}</div>
                        <div class="task-badge ${success ? 'badge-success' : 'badge-failure'}">
                            ${success ? '‚úÖ Completed' : '‚ùå Not Completed'}
                        </div>
                    </div>
                    
                    <div class="task-metrics">
                        <div class="metric">
                            <div class="metric-value">${ease}/5</div>
                            <div class="metric-label">Ease Rating ${getStars(ease)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${time}</div>
                            <div class="metric-label">Time Taken</div>
                        </div>
                    </div>
                    
                    ${difficulties !== 'None reported' ? `
                        <div class="feedback-box" style="border-left-color: #e74c3c; background: #fee;">
                            <div class="feedback-label">‚ö†Ô∏è Difficulties Encountered:</div>
                            <div>${difficulties}</div>
                        </div>
                    ` : ''}
                    
                    ${feedback !== 'No additional feedback' ? `
                        <div class="feedback-box">
                            <div class="feedback-label">üí≠ Additional Feedback:</div>
                            <div>${feedback}</div>
                        </div>
                    ` : ''}
                `;
                journey.appendChild(taskItem);
            }
            
            // Create chart
            try {
                const ctx = document.getElementById('taskPerformanceChart');
                if (!ctx) {
                    console.error('Canvas element taskPerformanceChart not found');
                    return;
                }
                
                console.log('Creating task performance chart with data:', easeData);
                console.log('Canvas element:', ctx);
                console.log('Canvas dimensions:', ctx.clientWidth, 'x', ctx.clientHeight);
                
                // Ensure canvas has dimensions
                if (ctx.clientWidth === 0 || ctx.clientHeight === 0) {
                    console.warn('Canvas has zero dimensions! Setting explicit size...');
                    ctx.style.width = '100%';
                    ctx.style.height = '300px';
                }
                
                // Destroy existing chart if it exists
                if (charts.taskPerformance) {
                    charts.taskPerformance.destroy();
                }
                
                charts.taskPerformance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Task 1', 'Task 2', 'Task 3', 'Task 4', 'Task 5', 'Task 6'],
                        datasets: [{
                            label: 'Ease Rating',
                            data: easeData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 8,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Task Ease Ratings Over Time'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                console.log('Task performance chart created successfully');
            } catch (error) {
                console.error('Error creating task performance chart:', error);
            }
        }
        
        function buildSUSBreakdown() {
            if (!participantData.posttest) {
                document.getElementById('susComparison').innerHTML = '<p style="color: #e74c3c; padding: 20px; text-align: center;">‚ùå Post-test data not loaded. Please upload the post-test questionnaire JSON file.</p>';
                return;
            }
            
            const susAnswers = [];
            for (let i = 1; i <= 10; i++) {
                susAnswers.push(parseInt(participantData.posttest.responses[`sus${i}`]));
            }
            
            try {
                const ctx = document.getElementById('susBreakdownChart');
                if (!ctx) {
                    console.error('Canvas element susBreakdownChart not found');
                    return;
                }
                
                console.log('Creating SUS breakdown chart');
                console.log('Canvas dimensions:', ctx.clientWidth, 'x', ctx.clientHeight);
                
                // Ensure canvas has dimensions
                if (ctx.clientWidth === 0 || ctx.clientHeight === 0) {
                    console.warn('Canvas has zero dimensions! Setting explicit size...');
                    ctx.style.width = '100%';
                    ctx.style.height = '300px';
                }
                
                // Destroy existing chart if it exists
                if (charts.susBreakdown) {
                    charts.susBreakdown.destroy();
                }
                
                charts.susBreakdown = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [
                            'Q1: Use frequently',
                            'Q2: Unnecessarily complex',
                            'Q3: Easy to use',
                            'Q4: Need support',
                            'Q5: Well integrated',
                            'Q6: Too much inconsistency',
                            'Q7: Learn quickly',
                            'Q8: Cumbersome',
                            'Q9: Felt confident',
                            'Q10: Needed to learn a lot'
                        ],
                        datasets: [{
                            label: 'Response (1-5)',
                            data: susAnswers,
                            backgroundColor: susAnswers.map((val, idx) => {
                                // Positive questions (odd indices): higher is better
                                // Negative questions (even indices): lower is better
                                if (idx % 2 === 0) {
                                    return val >= 4 ? '#2ecc71' : val >= 3 ? '#f39c12' : '#e74c3c';
                                } else {
                                    return val <= 2 ? '#2ecc71' : val <= 3 ? '#f39c12' : '#e74c3c';
                                }
                            })
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Individual SUS Question Responses'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 5
                            }
                        }
                    }
                });
                console.log('SUS breakdown chart created successfully');
            } catch (error) {
                console.error('Error creating SUS breakdown chart:', error);
            }
            
            // Comparison note
            const susScore = participantData.posttest.susScore;
            const comparison = document.getElementById('susComparison');
            comparison.innerHTML = `
                <strong>Score Interpretation:</strong> ${susScore.toFixed(1)}/100 - ${getSUSGrade(susScore)}<br>
                Industry average SUS score is around 68. This participant scored ${susScore >= 68 ? 'above' : 'below'} average.
            `;
        }
        
        function buildFeatureAssessment() {
            const section = document.getElementById('featureAssessment');
            section.innerHTML = '';
            
            if (!participantData.posttest) return;
            
            const responses = participantData.posttest.responses;
            
            const mostValuable = responses['most-valuable'];
            const satisfaction = getNumericValue(responses, 'satisfaction');
            const continueUse = getNumericValue(responses, 'continue-use');
            
            section.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-item">
                        <div class="profile-label">Most Valuable Feature</div>
                        <div class="profile-value">${formatFeatureName(mostValuable)}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Overall Satisfaction</div>
                        <div class="profile-value">${satisfaction !== null ? `${satisfaction}/5 ${getStars(satisfaction)}` : 'N/A'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Likelihood to Continue</div>
                        <div class="profile-value">${continueUse !== null ? `${continueUse}/5 ${getStars(continueUse)}` : 'N/A'}</div>
                    </div>
                </div>
            `;
        }
        
        function buildFeedback() {
            const section = document.getElementById('feedbackSection');
            section.innerHTML = '';
            
            if (!participantData.posttest) return;
            
            const responses = participantData.posttest.responses;
            
            const feedbackItems = [
                { title: 'üåü What They Loved', key: 'liked-most', color: '#2ecc71' },
                { title: '‚ö†Ô∏è Areas for Improvement', key: 'improvements', color: '#e74c3c' },
                { title: 'üìù Additional Feedback', key: 'additional-feedback', color: '#9b59b6' }
            ];
            
            feedbackItems.forEach(item => {
                const value = responses[item.key];
                if (value) {
                    const box = document.createElement('div');
                    box.className = 'quote-section';
                    box.style.borderLeftColor = item.color;
                    box.innerHTML = `
                        <div class="feedback-label">${item.title}</div>
                        <div class="quote-text">"${value}"</div>
                    `;
                    section.appendChild(box);
                }
            });
            
            // NPS Reason
            const npsReason = responses['nps-reason'];
            if (npsReason) {
                const npsScore = parseInt(responses.nps);
                const box = document.createElement('div');
                box.className = 'quote-section';
                box.style.borderLeftColor = getNPSColor(npsScore);
                box.innerHTML = `
                    <div class="feedback-label">‚≠ê Why They Gave NPS ${npsScore}/10</div>
                    <div class="quote-text">"${npsReason}"</div>
                `;
                section.appendChild(box);
            }
        }
        
        function getSUSGrade(score) {
            if (score >= 80.3) return 'üåü Excellent';
            if (score >= 68) return '‚úÖ Good';
            if (score >= 51) return '‚ö†Ô∏è OK';
            return '‚ùå Poor';
        }
        
        function getNPSCategory(score) {
            if (score >= 9) return 'üåü Promoter';
            if (score >= 7) return 'üòê Passive';
            return 'üòû Detractor';
        }
        
        function getNPSColor(score) {
            if (score >= 9) return '#2ecc71';
            if (score >= 7) return '#f39c12';
            return '#e74c3c';
        }
        
        function formatFeatureName(name) {
            if (!name) return 'Not specified';
            return name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function getStars(rating) {
            const stars = '‚≠ê'.repeat(Math.round(rating));
            return `<span class="rating-stars">${stars}</span>`;
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(participantData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${participantId}-report-${Date.now()}.json`;
            link.click();
        }
    </script>
</body>
</html>

